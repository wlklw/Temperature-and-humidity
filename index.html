<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æº«æ¿•åº¦æ•¸æ“šåˆ†æå„€ - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        input[type="file"] {
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            background: rgba(102, 126, 234, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="file"]:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.05);
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            background: #667eea;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background: #5b69c7;
        }

        select, input[type="file"] {
            padding: 10px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            background: white;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .chart-container {
            position: relative;
            height: 600px;
            margin: 30px 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .status {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: 500;
        }

        .status.info {
            background: rgba(52, 152, 219, 0.1);
            color: #2980b9;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .status.success {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .status.error {
            background: rgba(231, 76, 60, 0.1);
            color: #c0392b;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .file-list {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
            list-style-type: none;
            padding: 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            h1 {
                font-size: 2em;
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 400px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š æº«æ¿•åº¦æ•¸æ“šåˆ†æå„€ - å°ˆæ¥­ç‰ˆ</h1>

        <div class="controls">
            <div class="control-group">
                <label for="fileInput">ğŸ“ é¸æ“‡CSVæª”æ¡ˆ (å¯å¤šé¸)</label>
                <input type="file" id="fileInput" accept=".csv" multiple />
                <ul id="fileList" class="file-list"></ul>
            </div>
            
            <div class="control-group">
                <label for="timeInterval">â±ï¸ æ™‚é–“é–“è·</label>
                <select id="timeInterval">
                    <option value="1">æ¯å°æ™‚</option>
                    <option value="2">æ¯2å°æ™‚</option>
                    <option value="6">æ¯6å°æ™‚</option>
                    <option value="24" selected>æ¯å¤©</option>
                    <option value="240">æ¯10å¤©</option>
                    <option value="monthly">æ¯æœˆ</option>
                </select>
            </div>

            <div class="control-group">
                <label>ğŸ–¼ï¸ åœ–è¡¨æ“ä½œ</label>
                <button id="exportButton">åŒ¯å‡ºåœ–è¡¨ç‚º JPG</button>
            </div>
        </div>

        <div id="status" class="status info">
            è«‹ä¸Šå‚³ä¸€å€‹æˆ–å¤šå€‹CSVæª”æ¡ˆé–‹å§‹åˆ†æ
        </div>

        <div class="chart-container">
            <canvas id="chart"></canvas>
        </div>
    </div>

    <script>
        let rawData = {};
        let chart = null;
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4'];

        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const timeInterval = document.getElementById('timeInterval');
        const exportButton = document.getElementById('exportButton');
        const status = document.getElementById('status');
        const ctx = document.getElementById('chart').getContext('2d');

        // åˆå§‹åŒ–åœ–è¡¨
        function initChart() {
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'æº«æ¿•åº¦è®ŠåŒ–åœ–',
                            font: { size: 18, weight: 'bold' }
                        },
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'yyyy/MM/dd HH:mm',
                                displayFormats: {
                                    hour: 'MM/DD HH:mm',
                                    day: 'yyyy/MM/DD',
                                    month: 'yyyy/MM'
                                }
                            },
                            title: { display: true, text: 'æ™‚é–“' }
                        },
                        y: {
                            title: { display: true, text: 'æº«åº¦ (Â°C)' },
                            position: 'left',
                            id: 'y-axis-temp'
                        },
                        y1: {
                            title: { display: true, text: 'æ¿•åº¦ (%)' },
                            position: 'right',
                            id: 'y-axis-humid',
                            min: 0,
                            max: 100,
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // è™•ç†æª”æ¡ˆä¸Šå‚³
        fileInput.addEventListener('change', async function(e) {
            const files = e.target.files;
            if (files.length === 0) return;

            updateStatus('æ­£åœ¨è®€å–æª”æ¡ˆ...', 'info');
            fileList.innerHTML = '';
            rawData = {};

            try {
                const parsePromises = Array.from(files).map(file => {
                    return new Promise((resolve, reject) => {
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            dynamicTyping: true,
                            complete: function(results) {
                                const validData = results.data.filter(row => {
                                    return row['Local Date Time'] && !isNaN(parseFloat(row['Ch.1[C]'])) && !isNaN(parseFloat(row['Ch.2[%]']));
                                });
                                if (validData.length === 0) {
                                    reject(new Error(`æª”æ¡ˆ ${file.name} ä¸­æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æº«æ¿•åº¦æ•¸æ“š`));
                                } else {
                                    rawData[file.name] = validData.sort((a, b) => moment(a['Local Date Time']) - moment(b['Local Date Time']));
                                    resolve();
                                }
                            },
                            error: function(error) {
                                reject(new Error(`æª”æ¡ˆ ${file.name} è®€å–å¤±æ•—ï¼š${error.message}`));
                            }
                        });
                    });
                });

                await Promise.all(parsePromises);
                updateStatus(`æˆåŠŸè®€å– ${files.length} å€‹æª”æ¡ˆ`, 'success');
                Array.from(files).forEach(file => {
                    const li = document.createElement('li');
                    li.textContent = `âœ… ${file.name}`;
                    fileList.appendChild(li);
                });

                updateChart();

            } catch (error) {
                updateStatus('æª”æ¡ˆè™•ç†å¤±æ•—ï¼š' + error.message, 'error');
                rawData = {};
                fileList.innerHTML = '';
            }
        });

        // æ›´æ–°åœ–è¡¨
        function updateChart() {
            if (Object.keys(rawData).length === 0) return;

            const intervalType = timeInterval.value;
            const datasets = [];
            const files = Object.keys(rawData);

            files.forEach((file, fileIndex) => {
                const fileData = rawData[file];
                const baseColor = colors[fileIndex % colors.length];

                let processedData = [];

                if (intervalType === 'monthly') {
                    const monthlyGroups = fileData.reduce((acc, row) => {
                        const date = moment(row['Local Date Time']);
                        const yearMonth = date.format('YYYY-MM');
                        if (!acc[yearMonth]) {
                            acc[yearMonth] = { tempSum: 0, humidSum: 0, count: 0 };
                        }
                        const temp = parseFloat(row['Ch.1[C]']);
                        const humid = parseFloat(row['Ch.2[%]']);
                        if (!isNaN(temp)) { acc[yearMonth].tempSum += temp; }
                        if (!isNaN(humid)) { acc[yearMonth].humidSum += humid; }
                        acc[yearMonth].count++;
                        return acc;
                    }, {});

                    processedData = Object.keys(monthlyGroups).map(key => ({
                        x: moment(key, 'YYYY-MM').toDate(),
                        temp: monthlyGroups[key].tempSum / monthlyGroups[key].count,
                        humid: monthlyGroups[key].humidSum / monthlyGroups[key].count
                    }));
                } else {
                    const interval = parseInt(intervalType);
                    for (let i = 0; i < fileData.length; i += interval) {
                        let tempSum = 0, humidSum = 0;
                        let tempCount = 0, humidCount = 0;
                        
                        for (let j = i; j < i + interval && j < fileData.length; j++) {
                            const temp = parseFloat(fileData[j]['Ch.1[C]']);
                            const humid = parseFloat(fileData[j]['Ch.2[%]']);
                            if (!isNaN(temp)) { tempSum += temp; tempCount++; }
                            if (!isNaN(humid)) { humidSum += humid; humidCount++; }
                        }
                        processedData.push({
                            x: moment(fileData[i]['Local Date Time']).toDate(),
                            temp: tempCount > 0 ? tempSum / tempCount : null,
                            humid: humidCount > 0 ? humidSum / humidCount : null
                        });
                    }
                }
                
                // æº«åº¦æ•¸æ“šé›† (å¯¦ç·š)
                datasets.push({
                    label: `${file.replace('.csv', '')} - æº«åº¦`,
                    data: processedData.map(d => ({ x: d.x, y: d.temp })),
                    borderColor: baseColor,
                    backgroundColor: baseColor + '20',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    yAxisID: 'y-axis-temp'
                });

                // æ¿•åº¦æ•¸æ“šé›† (è™›ç·š)
                datasets.push({
                    label: `${file.replace('.csv', '')} - æ¿•åº¦`,
                    data: processedData.map(d => ({ x: d.x, y: d.humid })),
                    borderColor: baseColor,
                    backgroundColor: baseColor + '20',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    borderDash: [5, 5],
                    yAxisID: 'y-axis-humid'
                });
            });

            // æ›´æ–°æ™‚é–“è»¸å–®ä½
            let unit = 'day';
            if (intervalType === 'monthly') {
                unit = 'month';
            } else if (parseInt(intervalType) < 24) {
                unit = 'hour';
            }
            chart.options.scales.x.time.unit = unit;

            chart.data.labels = []; // ä½¿ç”¨ x-axis çš„ time type æ™‚ï¼Œä¸éœ€è¨­å®š labels
            chart.data.datasets = datasets;
            chart.update('none');
        }
        
        // åŒ¯å‡ºåœ–è¡¨åŠŸèƒ½
        exportButton.addEventListener('click', function() {
            if (Object.keys(rawData).length === 0) {
                updateStatus('è«‹å…ˆä¸Šå‚³æª”æ¡ˆä¸¦ç”¢ç”Ÿåœ–è¡¨', 'error');
                return;
            }
            const link = document.createElement('a');
            link.href = chart.toBase64Image('image/jpeg', 1);
            link.download = 'æº«æ¿•åº¦æ•¸æ“šåœ–è¡¨.jpeg';
            link.click();
            updateStatus('åœ–è¡¨å·²åŒ¯å‡º', 'success');
        });

        // äº‹ä»¶ç›£è½å™¨
        timeInterval.addEventListener('change', function() {
            if (Object.keys(rawData).length > 0) {
                updateChart();
            }
        });

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        initChart();
    </script>
</body>
</html>
