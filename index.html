<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>進階溫濕度數據分析儀</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            align-items: end;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        input[type="file"] {
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            background: rgba(102, 126, 234, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        input[type="file"]:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.05);
        }
        
        select, button {
            padding: 12px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            background: white;
            font-size: 14px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            font-weight: bold;
            border-color: #667eea;
        }

        button:hover {
            background: #5a6fd5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            position: relative;
            height: 600px;
            margin: 30px 0;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .status {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .status.info {
            background: rgba(52, 152, 219, 0.1);
            color: #2980b9;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .status.success {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }
        
        .status.error {
            background: rgba(231, 76, 60, 0.1);
            color: #c0392b;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 400px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌡️ 進階溫濕度數據分析儀</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="fileInput">📁 選擇CSV檔案 (可多選)</label>
                <input type="file" id="fileInput" accept=".csv" multiple />
            </div>
            
            <div class="control-group">
                <label for="timeInterval">⏱️ 時間間距</label>
                <select id="timeInterval">
                    <option value="1">每小時</option>
                    <option value="2">每2小時</option>
                    <option value="6">每6小時</option>
                    <option value="12">每12小時</option>
                    <option value="24" selected>每天</option>
                    <option value="240">10天平均</option>
                    <option value="720">月平均</option>
                </select>
            </div>

            <div class="control-group">
                 <label> &nbsp; </label> <button id="exportBtn">🖼️ 匯出 JPG 檔</button>
            </div>
        </div>
        
        <div id="status" class="status info">
            請上傳CSV檔案開始分析
        </div>
        
        <div class="chart-container">
            <canvas id="chart"></canvas>
        </div>
    </div>

    <script>
        let allFilesData = [];
        let chart = null;
        
        const colors = [
            { temp: '#FF6B6B', hum: '#4ECDC4' },
            { temp: '#F7DC6F', hum: '#45B7D1' },
            { temp: '#FFA07A', hum: '#98D8C8' },
            { temp: '#DDA0DD', hum: '#6A89CC' }
        ];
        
        const fileInput = document.getElementById('fileInput');
        const timeInterval = document.getElementById('timeInterval');
        const exportBtn = document.getElementById('exportBtn');
        const status = document.getElementById('status');
        const ctx = document.getElementById('chart').getContext('2d');
        
        function initChart() {
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        title: { display: true, text: '溫濕度變化比較圖', font: { size: 18, weight: 'bold' } },
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        const unit = context.dataset.yAxisID === 'yTemp' ? ' °C' : ' %';
                                        label += context.parsed.y.toFixed(2) + unit;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { display: true, title: { display: true, text: '時間' } },
                        yTemp: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: '溫度 (°C)', color: '#E74C3C' },
                            ticks: { color: '#E74C3C' }
                        },
                        yHum: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: '濕度 (%)', color: '#3498DB' },
                            ticks: { color: '#3498DB' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
        
        function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function parseFile(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true,
                    complete: (results) => {
                        try {
                            const rawData = results.data.filter(row =>
                                row['Local Date Time'] &&
                                typeof row['Ch.1[C]'] === 'number' &&
                                typeof row['Ch.2[%]'] === 'number'
                            );
                            if (rawData.length === 0) {
                                return reject(new Error(`檔案 "${file.name}" 中沒有有效的數據`));
                            }
                            resolve({ name: file.name, data: rawData });
                        } catch (error) {
                            reject(new Error(`處理檔案 "${file.name}" 失敗: ${error.message}`));
                        }
                    },
                    error: (error) => reject(new Error(`讀取檔案 "${file.name}" 失敗: ${error.message}`))
                });
            });
        }

        fileInput.addEventListener('change', async function(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            updateStatus(`正在讀取 ${files.length} 個檔案...`, 'info');
            
            const parsePromises = Array.from(files).map(parseFile);

            try {
                allFilesData = await Promise.all(parsePromises);
                const totalRecords = allFilesData.reduce((sum, file) => sum + file.data.length, 0);
                updateStatus(`成功讀取 ${allFilesData.length} 個檔案，共 ${totalRecords} 筆有效數據`, 'success');
                processAndDrawChart();
            } catch (error) {
                updateStatus(error.message, 'error');
            }
        });

        function processDataForFile(fileData, interval) {
            const rawData = fileData.data;
            if (interval <= 24) { // 逐點取樣
                const processed = [];
                for (let i = 0; i < rawData.length; i += interval) {
                    processed.push(rawData[i]);
                }
                return processed;
            } else { // 時間區段平均
                const groups = {};
                rawData.forEach(row => {
                    const date = new Date(row['Local Date Time']);
                    let key;
                    if (interval === 240) { // 10天平均
                        const year = date.getFullYear();
                        const dayOfYear = Math.floor((date - new Date(year, 0, 0)) / 86400000);
                        const period = Math.floor(dayOfYear / 10);
                        key = `${year}-D10-${period}`;
                    } else { // 月平均 (interval 720)
                        key = `${date.getFullYear()}-${date.getMonth()}`;
                    }

                    if (!groups[key]) {
                        groups[key] = {
                            date: date,
                            tempSum: 0,
                            humSum: 0,
                            count: 0
                        };
                    }
                    groups[key].tempSum += row['Ch.1[C]'];
                    groups[key].humSum += row['Ch.2[%]'];
                    groups[key].count++;
                });

                return Object.values(groups).map(g => ({
                    'Local Date Time': g.date,
                    'Ch.1[C]': g.tempSum / g.count,
                    'Ch.2[%]': g.humSum / g.count,
                })).sort((a,b) => new Date(a['Local Date Time']) - new Date(b['Local Date Time']));
            }
        }
        
        function updateChart() {
            if (!chart || allFilesData.length === 0) return;
            
            const interval = parseInt(timeInterval.value);
            const datasets = [];
            let commonLabels = [];
            
            allFilesData.forEach((file, index) => {
                const processedData = processDataForFile(file, interval);
                if(index === 0) { // 以第一個檔案的時間軸為基準
                     commonLabels = processedData.map(row => {
                        const date = new Date(row['Local Date Time']);
                        if (interval === 720) return date.toLocaleString('zh-TW', { year: 'numeric', month: 'long' });
                        if (interval === 240) return `始於 ${date.toLocaleDateString('zh-TW')}`;
                        return date.toLocaleString('zh-TW', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    });
                }

                const colorPair = colors[index % colors.length];

                datasets.push({
                    label: `${file.name} - 溫度`,
                    data: processedData.map(row => row['Ch.1[C]']),
                    borderColor: colorPair.temp,
                    backgroundColor: colorPair.temp + '33', // 33 for ~20% opacity
                    borderWidth: 2.5,
                    fill: false,
                    tension: 0.1,
                    yAxisID: 'yTemp'
                });

                datasets.push({
                    label: `${file.name} - 濕度`,
                    data: processedData.map(row => row['Ch.2[%]']),
                    borderColor: colorPair.hum,
                    backgroundColor: colorPair.hum + '33',
                    borderWidth: 2.5,
                    fill: false,
                    tension: 0.1,
                    yAxisID: 'yHum'
                });
            });
            
            chart.data.labels = commonLabels;
            chart.data.datasets = datasets;
            chart.update('none');
        }
        
        function processAndDrawChart() {
             if (allFilesData.length > 0) {
                updateChart();
            }
        }

        function exportChart() {
            // 建立一個新的 canvas 並填滿白色背景
            const canvas = document.getElementById('chart');
            const newCanvas = document.createElement('canvas');
            newCanvas.width = canvas.width;
            newCanvas.height = canvas.height;
            const newCtx = newCanvas.getContext('2d');
            newCtx.fillStyle = '#FFFFFF';
            newCtx.fillRect(0, 0, newCanvas.width, newCanvas.height);
            
            // 將原始圖表繪製到新的 canvas 上
            newCtx.drawImage(canvas, 0, 0);

            // 匯出新 canvas 的內容
            const image = newCanvas.toDataURL('image/jpeg', 1.0);
            const link = document.createElement('a');
            link.href = image;
            link.download = `溫濕度分析圖_${new Date().toISOString().slice(0,10)}.jpg`;
            link.click();
        }

        // 事件監聽器
        timeInterval.addEventListener('change', processAndDrawChart);
        exportBtn.addEventListener('click', exportChart);
        
        // 初始化
        initChart();
        updateStatus('請上傳CSV檔案開始分析', 'info');
    </script>
</body>
</html>
